
{% extends "generic.html" %} 
{% load static %}

{% block extra_head %}
<link href="{% static 'css/home/home_styles.css' %}" rel="stylesheet">

{% endblock %}

{% block body %}   
<section class="container-fluid d-flex flex-wrap my-5">

<section id="top_section " class="container-fluid d-flex justify-content-end flex-wrap ">
  <section class="col-5 container-fluid  d-flex flex-wrap mx-5">
    <div class="col-6">
      <a href="#">
      <button id="work-button" class="big-button" data-toggle="modal" data-target="#confirmationModal">trabajo</button>
      </a>
    </div>
    <div class="col-6">
      <a href="#">
        <button id="break-button" class="big-button" data-toggle="modal" data-target="#confirmationModal" disabled="true">descanso</button>
      </a>
    </div>
  </section>
  <!--MANDADOR DE TICKETS-->
  <section class="col-6 container-fluid d-flex flex-wrap justify-content-center font-white mx-0 px-0 ml-3">
    <div class="border text-center p-3  background-blue" style="width: 100%;">
        <h3>INFORMAR</h3>
        <hr>
        <form action="{% url 'send_notification' %}" method="post">
            {% csrf_token %} {{ form }}
            <hr>
            <input class="btn btn-info" type="submit" value="Enviar al administrador">
        </form>
    </div>
</section>
</section>
<section class="container-fluid d-flex flex-wrap justify-content-center text-center font-white mt-4 ">
  <div class="container-fluid background-blue  border">
    <div class="container-fluid row mx-1  py-2">
        <h4 class="col-3">Tipo</h4>
        <h4 class="col-3">Fecha</h4>
        <h4 class="col-3">Hora</h4>
        <img class="col-3" id="refreshButton" src="{% static 'media/images/refresh_button.png' %}"  alt="refresh">
        
    </div>
    <hr>
    <div id="register_container">

    </div>
    </section>

            <!--{% for employee in employees %} 
    <div class="container-fluid row">
        <h3 class="col-3">{{ employee.dni }}</h3>
        <h3 class="col-8">{{ employee.name }} {{ employee.surname }}</h3>
        <div class="container-fluid col-1">
            <button class="btn col-3" data-toggle="modal" data-target="#createUserModal" data-whatever="Editar Usuario">R</button>
            <button class="btn col-3">V</button>
            <button class="btn col-3">D</button>
        </div>
    </div>
     {% endfor %}-->





    <!--
  <div class=" col-sm-12 col-md-6 relative text-end m-4">
    <a href="#">
        <img class="blur borderR-20px" src="{% static 'media/images/enter_work_background.png' %}" alt="enter_work_background">
        <div class="image_text ">
           <h5 class="pr-3 pl-3 mb-2 mx-5">ENTRAR TRABAJO</h5>
  
        </div>
    </a>
  </div>


    <div class=" col-sm-12 col-md-6 relative text-end m-4">
    <a href="#">
        <img class="blur borderR-20px" src="" alt="">
        <div class="image_text ">
           <h5 class="pr-3 pl-3 mb-2 mx-5">hkk</h5>
        </div>
    </a>
  </div>

-->
    <!-- Modal -->
<!-- Button trigger modal -->
<!-- Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel"></h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
        <button id="confirmationButton" type="button" class="btn btn-primary" data-dismiss="modal">Confirmar</button>
      </div>
    </div>
  </div>
</div>

</section>

{% endblock body%}
{% block extra_scripts %}
<script>
$(document).ready(function(){
  
  var workingStatus = '{{workingStatus}}';
  var textToShowInModal ="default"
  var data = {}
  if(workingStatus == "isntWorking"){
            $("#break-button" ).prop('disabled', true)
  }else if(workingStatus == "isWorking"){
              $("#break-button" ).prop('disabled', false)
  }else if(workingStatus == "breaking"){
              $("#work-button" ).prop('disabled', true)
  }

  $('#confirmationModal').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget) // Button that triggered the modal
            //var recipient = button.data('whatever') // Extract info from data-* attributes
            //document.getElementById("type").value = recipient
            var modal = $(this)
            modal.find('.modal-title').text(textToShowInModal)
        })
  $("#work-button").click(function() {
      if(workingStatus == "isntWorking"){
          data = {
            'state' : 0,
            'interaction_type' : "work" ,              
          }
          textToShowInModal = "多Entrar al trabajo?"

         
          //sendDataToDb(data);
      }else if(workingStatus == "isWorking"){
          data = {
            'state' : 1,
            'interaction_type' : "work",             
          }
          textToShowInModal = "多Salir del trabajo?"
          $("#break-button" ).prop('disabled', false)
          //sendDataToDb(data);
      }else if(workingStatus == "breaking"){
          alert("No puedes salir del trabajo sin haber salido del descanso")
      }


  });

  $("#break-button").click(function() {

      if(workingStatus == "isntWorking"){
          alert("No puedes entrar al descanso si no estas trabajando")
      }else if(workingStatus == "isWorking"){
          data = {
            'state' : 0,
            'interaction_type' : "break",              
          }
          textToShowInModal = "多Entrar al descanso?"
         
      }else if(workingStatus == "breaking"){
          data = {
            'state' : 1,
            'interaction_type' : "break",                
          }
          textToShowInModal = "多Salir del descanso?"
      }
  });
  $("#confirmationButton").click(function() {
    sendDataToDb(data)


  });
  
  function sendDataToDb(data){
    //
      console.log("valor del data-> "+ JSON.stringify((data)))      
     $.ajax({
       url: '/ajax/insert_job_interaction/',
       type: 'POST',
       data: data,
       headers: {'X-CSRFToken': "{{csrf_token}}"},
       success: function (data) {
        alert("Correcto")
       
        },
        error: function(jqxhr) {
            alert("Error"); 
        }    
    });
  }

  $("#refreshButton").click(function() {
    $.ajax({
       url: '/ajax/get_employee_job_interactions/',
       type: 'GET',
       dataType: 'json',
       data: data,
       headers: {'X-CSRFToken': "{{csrf_token}}"},
       success: function (data) {
        $("#register_container").empty()
        data.forEach(interaction => {
          //RESOLV FIELDS

          date = new Date(interaction.fields.date_time);
          year = date.getFullYear();
          month = date.getMonth()+1;
          dt = date.getDate();

          if (dt < 10) {
            dt = '0' + dt;
          }
          if (month < 10) {
            month = '0' + month;
          }
          datetimeResolved = year+'-' + month + '-'+dt

          interactionTypeResolved = ""
          if(interaction.fields.interaction_type == "work"){
            interactionTypeResolved ="Trabajo"
          }else{
            interactionTypeResolved ="Descanso"
          }

          stateResolved = ""
          if(interaction.fields.state == 0){
            stateResolved ="Entrada"
          }else{
            stateResolved ="Salida"
          }
          
          $("#register_container").append(` 
            <div  class="container-fluid background-grey font-black row m-1  py-1">
              <h5 class="col-3">`+datetimeResolved+`</h5>
              <h5 class="col-3">`+stateResolved+`</h5>
              <h5 class="col-3">`+interactionTypeResolved+`</h5> 
            </div>`
          );

        });
        },
        error: function(jqxhr) {
            alert("Error refreshing"); 
        }    
    });
  });

  $("#refreshButton").click()
});
</script>
 <!--
   <script src="{% static 'js/home.js' %}"></script>
--> 
   
{% endblock %}
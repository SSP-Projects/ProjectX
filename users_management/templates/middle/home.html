{% extends "generic.html" %} {% load static %} {% block extra_head %}
<link href="{% static 'css/home/home_styles.css' %}" rel="stylesheet"> {% endblock %} {% block body %} {% include "top/header.html" %}

<section class="container-fluid d-flex flex-wrap my-4">

    <section id="top_section " class="container-fluid d-flex justify-content-end flex-wrap ">
        <section class="col-5 container-fluid  d-flex flex-wrap mx-5">
            <div class="col-6 align-middle  d-flex" style="align-items:center;">

                <button id="work-button" class="btn rounded-circle w-75 h-75 p-0" data-toggle="modal" data-target="#confirmationModal"><img class="img-fluid"  id="work-button-img"></button>
                <!--<button id="work-button" class="big-button" data-toggle="modal" data-target="#confirmationModal">trabajo</button>-->

            </div>
            <div class="col-6 align-middle  d-flex" style="align-items:center;">
                <button id="break-button" class="btn rounded-circle w-75 h-75 p-0" data-toggle="modal" data-target="#confirmationModal"><img class="img-fluid"  id="break-button-img"></button>
                <!-- <button id="break-button" class="big-button" data-toggle="modal" data-target="#confirmationModal" disabled="true">descanso</button>-->
            </div>
        </section>
        <!--MANDADOR DE TICKETS-->
        <section class="col-6 container-fluid d-flex flex-wrap justify-content-center font-white mx-0 px-0 ml-3">
            <div class="border text-center p-3  background-blue" style="width: 100%;">
                <h3>INFORMAR</h3>
                <hr>{{ form }}
                <hr>
                <button id="confirm_send" class="btn btn-info">Enviar al administrador</button>
            </div>
        </section>
        </div>
    </section>
</section>
<section class="container-fluid d-flex flex-wrap justify-content-center text-center font-white mt-4 ">
    <div class="container-fluid background-blue  border">
        <div class="container-fluid row mx-1  py-2 ">
            <h4 class="col-3 my-0">Tipo</h4>
            <h4 class="col-3 my-0">Acción</h4>
            <h4 class="col-3 my-0">Hora</h4>
            <div class="col-3 container-fluid row">
                <h4 class="col-10 my-0">Fecha</h4>
                <!--
            <img class="col-2" id="refreshButton" src="{% static 'media/images/refresh_button.png' %}"  alt="refresh">
            
          -->
                <script src="https://cdn.lordicon.com/libs/frhvbuzj/lord-icon-2.0.2.js"></script>
                <a class="col-2" href="#" id="#refreshButton">
                    <lord-icon src="https://cdn.lordicon.com/krmfspeu.json" trigger="click" colors="primary:#16a9c7,secondary:#86c716" stroke="68" scale="60" axis-x="49" style="width:60px;height:40px">
                    </lord-icon>
                </a>
            </div>

        </div>
        <hr>
        <div id="register_container">

        </div>
        <br>
    </div>
</section>

<!-- Modal -->
<!-- Button trigger modal -->
<!-- Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel"></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button id="confirmationButton" type="button" class="btn btn-primary" data-dismiss="modal">Confirmar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="showNotification" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Notificación enviada por el administrador</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="px-3">
                    <h5 id="show_notification_type" class="mb-3"></h5>
                    <textarea cols="40" rows="5" class="form-control no-resize" id="show_notification_description" readonly></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <input id="set_as_viewed" type="hidden">
                <button id="set_as_viewed_notification" type="button" class="btn btn-success" data-dismiss="modal">Marcar como leído</button>
            </div>
        </div>
    </div>
</div>

</section>

{% endblock body%} {% block extra_scripts %}
<script>
    $(document).ready(function() {
        $('#confirmationButtonSuccess').click(function() {
            location.reload();
        })
        $('#confirmationButtonError').click(function() {
            location.reload();
        })
        var workingStatus = '{{workingStatus}}';
        var textToShowInModal = "default"
        var data = {}
        if (workingStatus == "isntWorking") {
            $("#break-button").prop('disabled', true)
            $("#work-button-img").prop('src', "{% static 'media/images/enter_work_button.png' %}")
            $("#break-button-img").prop('src', "{% static 'media/images/enter_break_button.png' %}")
            $("#work-button").prop('title', "Entrar al trabajo")
            $("#break-button").prop('title', "No puedes entrar al descanso sin haber entrado al trabajo")
        } else if (workingStatus == "isWorking") {
            $("#break-button").prop('disabled', false)
            $("#work-button-img").prop('src', "{% static 'media/images/exit_work_button.png' %}")
            $("#break-button-img").prop('src', "{% static 'media/images/enter_break_button.png' %}")
            $("#work-button").prop('title', "Salir del trabajo")
            $("#break-button").prop('title', "Entrar al descanso")
        } else if (workingStatus == "breaking") {
            $("#work-button-img").prop('src', "{% static 'media/images/exit_work_button.png' %}")
            $("#break-button-img").prop('src', "{% static 'media/images/enter_work_button.png' %}")
            $("#work-button").prop('title', "No puedes salir del trabajo sin haber salido del descanso")
            $("#break-button").prop('title', "Salir del descanso")
            $("#work-button").prop('disabled', true)
            $("#break-button").prop('disabled', false)
        }

        $('#confirmationModal').on('show.bs.modal', function(event) {
            var button = $(event.relatedTarget) // Button that triggered the modal
                //var recipient = button.data('whatever') // Extract info from data-* attributes
                //document.getElementById("type").value = recipient
            var modal = $(this)
            modal.find('.modal-title').text(textToShowInModal)
        })
        $("#work-button").click(function() {
            if (workingStatus == "isntWorking") {
                data = {
                    'state': 0,
                    'interaction_type': "work",
                }
                textToShowInModal = "¿Entrar al trabajo?"


                //sendDataToDb(data);
            } else if (workingStatus == "isWorking") {
                data = {
                    'state': 1,
                    'interaction_type': "work",
                }
                textToShowInModal = "¿Salir del trabajo?"
                $("#break-button").prop('disabled', false)
                    //sendDataToDb(data);
            } else if (workingStatus == "breaking") {
                alert("No puedes salir del trabajo sin haber salido del descanso")
            }


        });

        $("#break-button").click(function() {

            if (workingStatus == "isntWorking") {
                alert("No puedes entrar al descanso si no estas trabajando")
            } else if (workingStatus == "isWorking") {
                data = {
                    'state': 0,
                    'interaction_type': "break",
                }
                textToShowInModal = "¿Entrar al descanso?"

            } else if (workingStatus == "breaking") {
                data = {
                    'state': 1,
                    'interaction_type': "break",
                }
                textToShowInModal = "¿Salir del descanso?"
            }
        });
        $("#confirmationButton").click(function() {
            sendDataToDb(data)


        });

        function sendDataToDb(data) {
            //
            console.log("valor del data-> " + JSON.stringify((data)))
            $.ajax({
                url: '/ajax/insert_job_interaction/',
                type: 'POST',
                data: data,
                headers: {
                    'X-CSRFToken': "{{csrf_token}}"
                },
                success: function(data) {

                    Swal.fire({
                            icon: 'success',
                            title: 'Guardado, ¡gracias!',
                            showConfirmButton: false,
                            timer: 1500,
                            backdrop: 'rgba(80,80,80,0.4)'
                        })
                        .then(() => location.reload());

                },
                error: function(jqxhr) {

                    Swal.fire({
                            icon: 'error',
                            title: 'Oops...',
                            text: '¡Algo ha salido mal!',
                            footer: '<a href>¿Porque he tenido este problema?</a>',
                            backdrop: 'rgba(0,0,123,0.4)'
                        })
                        .then(() => location.reload());
                }
            });
        }
        //GET DE LAS INTERACCIONES
        function refreshInteractions() {

            $.ajax({
                url: '/ajax/get_employee_job_interactions/',
                type: 'GET',
                dataType: 'json',
                data: data,
                headers: {
                    'X-CSRFToken': "{{csrf_token}}"
                },
                success: function(data) {
                    $("#register_container").empty()
                    data.forEach(interaction => {
                        //RESOLV FIELDS

                        date = new Date(interaction.fields.date_time);
                        year = date.getFullYear();
                        month = date.getMonth() + 1;
                        dt = date.getDate();

                        if (dt < 10) {
                            dt = '0' + dt;
                        }
                        if (month < 10) {
                            month = '0' + month;
                        }
                        dateResolved = year + '-' + month + '-' + dt
                        timeResolved = date.toLocaleTimeString('es-ES')

                        interactionTypeResolved = ""
                        if (interaction.fields.interaction_type == "work") {
                            interactionTypeResolved = "Trabajo"
                        } else {
                            interactionTypeResolved = "Descanso"
                        }

                        stateResolved = ""
                        if (interaction.fields.state == 0) {
                            stateResolved = "Entrada"
                        } else {
                            stateResolved = "Salida"
                        }

                        $("#register_container").append(` 
            <div  class="container-fluid background-grey font-black row m-1  py-1">
              <h5 class="col-3">` + interactionTypeResolved + `</h5> 
              <h5 class="col-3">` + stateResolved + `</h5>
              <h5 class="col-3">` + timeResolved + `</h5>
              <div class="col-3 container-fluid row">
                <h5 class="col-10">` + dateResolved + `</h5>
              </div>
            </div>`);

                    });
                },
                error: function(jqxhr) {
                    alert("Error refreshing");
                }
            });
        }
        refreshInteractions()
    });

    $("#confirm_send").click(function() {
        n = document.getElementById('ticket_type')
        desc = document.getElementById('ticket_description')
        to_send = {
            "notification_type": n.options[n.selectedIndex].value,
            "notification_desc": desc.value
        }
        $.ajax({
            url: '/ajax/notification/',
            type: 'POST',
            data: to_send,
            headers: {
                'X-CSRFToken': "{{csrf_token}}"
            },
            success: function(data) {
                Swal.fire({
                    icon: 'success',
                    title: 'Enviado, ¡gracias!',
                    showConfirmButton: false,
                    timer: 1500,
                    backdrop: 'rgba(80,80,80,0.4)'
                })
                desc.value = ""
                $('#sendNotification').modal('toggle');
            },
            error: function(jqxhr) {
                alert("Error al enviar la notificación")
            }
        });
    });

    function refresh_notifications() {
        $.ajax({
            url: '/ajax/get_notifications/',
            type: 'POST',
            dataType: "json",
            headers: {
                'X-CSRFToken': "{{csrf_token}}"
            },
            success: function(data) {
                notification_panel = document.getElementById("notifications_dropdown")
                notification_panel.innerHTML = ""
                notification_number = document.getElementById("notification_number")
                notification_number.innerText = data.length
                data.forEach(notification => {
                    item = document.createElement("a")
                    item.setAttribute("class", "dropdown-item")
                    item.setAttribute("id", notification.id)
                    item.setAttribute("onclick", "show_notification(this)")
                    item.setAttribute("data-toggle", "modal")
                    item.setAttribute("data-target", "#showNotification")
                    item.innerText = notification.date + " " + notification.type
                    notification_panel.appendChild(item)
                });
            },
            error: function() {
                console.log("Error al traer las notificationes")
            }
        });
    }
    
    refresh_notifications();
    setInterval(refresh_notifications, 300000);

    function show_notifications() {
        document.getElementById("notifications_dropdown").classList.toggle("show");
    }

    function show_notification(notification) {
        $.ajax({
            url: '/ajax/get_notification_to_show_/',
            type: 'POST',
            dataType: "json",
            data: {
                'id': notification.id
            },
            headers: {
                'X-CSRFToken': "{{csrf_token}}"
            },
            success: function(data) {
                notification_type = document.getElementById("show_notification_type")
                notification_desc = document.getElementById("show_notification_description")
                set_as_viewed = document.getElementById("set_as_viewed")
                notification_type.innerHTML = data.type
                notification_desc.value = data.desc
                set_as_viewed.value = notification.id
            },
            error: function() {
                console.log("Error al traer las notificationes")
            }
        });
    }

    $("#set_as_viewed_notification").click(function() {
        $.ajax({
            url: '/ajax/set_notification_as_viewed/',
            type: 'POST',
            data: {
                'id': document.getElementById("set_as_viewed").value
            },
            headers: {
                'X-CSRFToken': "{{csrf_token}}"
            },
            success: function(data) {
                Swal.fire({
                    icon: 'success',
                    title: 'Listo, ¡gracias!',
                    showConfirmButton: false,
                    timer: 1500,
                    backdrop: 'rgba(80,80,80,0.4)'
                })
                desc.value = ""
                $('#sendNotification').modal('toggle');
            },
            error: function(jqxhr) {
                alert("Error al enviar la notificación")
            }
        });
    });
</script>
<!--
   <script src="{% static 'js/home.js' %}"></script>
-->

{% endblock %}